<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CP Manpower Allocator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    /* Watermark in allocation output */
    #allocationOutput {
      position: relative;
    }
    #allocationOutput::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 280px;
      height: 280px;
      background: url("https://lh3.googleusercontent.com/d/1oQr4RoR9ON5vK6U_oIN2hW0HdnpEloO8") no-repeat center;
      background-size: contain;
      opacity: 0.06;
      transform: translate(-50%, -50%);
      pointer-events: none;
      filter: grayscale(80%);
    }

    /* Table header theme */
    .thead-theme {
      background: linear-gradient(90deg, rgba(10,85,165,0.06), rgba(6,150,105,0.03));
    }

    /* TBA highlight */
    .tba {
      color: #b91c1c; /* red-700 */
      font-weight: 600;
    }

    /* Make table horizontally scrollable on small screens */
    .table-wrap {
      overflow-x: auto;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <!-- Header -->
    <div class="flex items-center gap-4">
      <img id="deptLogo" src="https://lh3.googleusercontent.com/d/1oQr4RoR9ON5vK6U_oIN2hW0HdnpEloO8" alt="Dept Logo" class="h-16 w-auto">
      <h1 class="text-3xl font-bold text-blue-800">CP Manpower Allocator</h1>
    </div>

    <!-- Uploads -->
    <section class="grid md:grid-cols-2 gap-6">
      <div class="bg-white rounded-xl shadow p-4 space-y-3 border border-blue-200">
        <h2 class="text-lg font-semibold text-blue-700">Upload Manpower List</h2>
        <input type="file" id="manpowerFile" accept=".csv, .xlsx" class="border rounded-lg p-2 w-full"/>
        <div id="manpowerNote" class="text-sm text-gray-500">
          Required columns: <strong>Company, Name, Badge, Craft, Vacation Start, Vacation Finish, Contract Start, Contract End</strong>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-4 space-y-3 border border-blue-200">
        <h2 class="text-lg font-semibold text-blue-700">Upload Project List</h2>
        <input type="file" id="projectFile" accept=".csv, .xlsx" class="border rounded-lg p-2 w-full"/>
        <div id="projectNote" class="text-sm text-gray-500">
          Required columns: <strong>Cost Center, Project, Craft, Pre Qty, Pre Start, Pre Finish, Main Qty, Main Start, Main Finish, Post Qty, Post Start, Post Finish</strong>
        </div>
      </div>
    </section>

    <!-- Buttons -->
    <div class="flex gap-3">
      <button id="btnAllocate" class="px-4 py-2 rounded-lg bg-blue-700 hover:bg-blue-800 text-white shadow">Allocate</button>
      <button id="btnExport" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white shadow" disabled>Download Excel</button>
    </div>

    <!-- Output -->
    <section class="bg-white rounded-xl shadow p-4 relative">
      <h2 class="text-lg font-semibold text-blue-700 mb-3">Allocation</h2>
      <div id="allocationOutput" class="overflow-auto max-h-[36rem] text-sm">
        <div class="text-gray-500">No allocation yet. Upload files and click <strong>Allocate</strong>.</div>
      </div>
    </section>
  </div>

<script>
/* ---------- Data holders ---------- */
let manpowerData = [];
let projectData = [];
let lastAllocation = null; // will hold last projects array for export

/* ---------- Utilities ---------- */
function parseDDMMMYY(s){
  if(!s) return null;
  const MONTHS = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
  const m = String(s).trim().match(/(\d{1,2})[\-\s]([A-Za-z]{3})[\-\s](\d{2,4})/);
  if(!m) return null;
  let y = parseInt(m[3],10);
  if(y < 100) y += 2000;
  const mon = MONTHS[m[2].toLowerCase()];
  if(mon === undefined) return null;
  return new Date(Date.UTC(y, mon, parseInt(m[1],10)));
}

function escapeCsvCell(s){
  if(s == null) return '';
  s = String(s);
  if(s.includes('"')) s = s.replace(/"/g,'""');
  if(s.includes(',') || s.includes('"') || s.includes('\n')) return `"${s}"`;
  return s;
}

function escapeHtml(s){
  if(s == null) return '';
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* ---------- File reading (SheetJS) ---------- */
function readFile(file, callback){
  const reader = new FileReader();
  reader.onerror = () => { alert('Failed to read file: ' + file.name); };
  if(file.name.toLowerCase().endsWith('.csv')){
    reader.onload = e => {
      const text = e.target.result;
      try {
        const workbook = XLSX.read(text, {type:'string'});
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, {defval:''});
        callback(json);
      } catch(err) {
        alert('Error parsing CSV: ' + err);
      }
    };
    reader.readAsText(file, 'UTF-8');
  } else {
    reader.onload = e => {
      try {
        const arr = new Uint8Array(e.target.result);
        const workbook = XLSX.read(arr, {type:'array'});
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, {defval:''});
        callback(json);
      } catch(err) {
        alert('Error parsing Excel: ' + err);
      }
    };
    reader.readAsArrayBuffer(file);
  }
}

/* ---------- DOM event handlers ---------- */
document.getElementById('manpowerFile').addEventListener('change', e => {
  const f = e.target.files[0];
  if(!f) return;
  readFile(f, json => {
    manpowerData = json;
    document.getElementById('manpowerNote').textContent = `Loaded ${json.length} row(s). Required columns: Company, Name, Badge, Craft, Vacation Start, Vacation Finish, Contract Start, Contract End`;
  });
});

document.getElementById('projectFile').addEventListener('change', e => {
  const f = e.target.files[0];
  if(!f) return;
  readFile(f, json => {
    projectData = json;
    document.getElementById('projectNote').textContent = `Loaded ${json.length} row(s). Required columns: Cost Center, Project, Craft, Pre Qty, Pre Start, Pre Finish, Main Qty, Main Start, Main Finish, Post Qty, Post Start, Post Finish`;
  });
});

/* ---------- Allocation logic ---------- */
function overlaps(a,b,x,y){ return a <= y && x <= b; }

function isAvailable(person, start, end){
  // check existing assignments
  for(const a of person.assignments){
    if(overlaps(a.start, a.end, start, end)) return false;
  }
  // check vacation
  if(person.vacStart && person.vacEnd && overlaps(person.vacStart, person.vacEnd, start, end)) return false;
  // check contract boundaries
  if(person.contractStart && start < person.contractStart) return false;
  if(person.contractEnd && end > person.contractEnd) return false;
  return true;
}

function allocate(){
  if(!manpowerData.length || !projectData.length){
    alert('Please upload both Manpower and Project files first.');
    return;
  }

  // build people array with parsed dates
  const people = manpowerData.map(p => ({
    company: p.Company || '',
    name: p.Name || '',
    badge: p.Badge || '',
    craft: (p.Craft || '').toString().toLowerCase(),
    vacStart: p['Vacation Start'] ? parseDDMMMYY(p['Vacation Start']) : null,
    vacEnd: p['Vacation Finish'] ? parseDDMMMYY(p['Vacation Finish']) : null,
    contractStart: p['Contract Start'] ? parseDDMMMYY(p['Contract Start']) : null,
    contractEnd: p['Contract End'] ? parseDDMMMYY(p['Contract End']) : null,
    assignments: []
  })).filter(x => x.name && x.badge);

  // convert projects to phase-level entries
  const projects = [];
  projectData.forEach(row => {
    ['Pre','Main','Post'].forEach(phase => {
      const qty = parseInt(row[phase + ' Qty']) || 0;
      const start = parseDDMMMYY(row[phase + ' Start']);
      const end = parseDDMMMYY(row[phase + ' Finish']);
      if(qty > 0 && start && end){
        projects.push({
          costCenter: row['Cost Center'] || '',
          project: row.Project || '',
          craft: (row.Craft || '').toString().toLowerCase(),
          qty: qty,
          start: start,
          end: end,
          phase: phase,
          assigned: []
        });
      }
    });
  });

  // sort phases by start date (stable)
  projects.sort((a,b) => a.start - b.start || a.end - b.end);

  // allocate for each phase
  for(const job of projects){
    let remaining = job.qty;

    // candidate ordering to balance use: fewest assignments first
    const candidates = people
      .filter(p => p.craft === job.craft)
      .sort((a,b) => a.assignments.length - b.assignments.length);

    for(const p of candidates){
      if(remaining <= 0) break;
      if(isAvailable(p, job.start, job.end)){
        // assign and block
        p.assignments.push({proj: job.project, start: job.start, end: job.end});
        job.assigned.push({company: p.company, name: p.name, badge: p.badge});
        remaining--;
      }
    }

    // Fill TBA placeholders for shortages
    for(let i=0;i<remaining;i++){
      job.assigned.push({company: 'TBA', name: `(${job.craft})`, badge: ''});
    }
  }

  // save for export
  lastAllocation = projects;

  // render to UI and enable export
  render(projects);
  const btn = document.getElementById('btnExport');
  btn.disabled = false;
  btn.onclick = () => exportExcel(projects);
}

/* ---------- Rendering (UI table) ---------- */
function render(projects){
  if(!projects.length){
    document.getElementById('allocationOutput').innerHTML = '<div class="text-gray-500">No phases found in project file (check columns & date format).</div>';
    return;
  }

  let html = '<div class="table-wrap"><table class="min-w-full border text-sm"><thead class="thead-theme"><tr>';
  html += '<th class="p-2 text-left">Cost Center</th>';
  html += '<th class="p-2 text-left">Project</th>';
  html += '<th class="p-2 text-left">Craft</th>';
  html += '<th class="p-2 text-left">Phase</th>';
  html += '<th class="p-2 text-left">Start</th>';
  html += '<th class="p-2 text-left">Finish</th>';
  html += '<th class="p-2 text-left">Qty</th>';
  html += '<th class="p-2 text-left">Company</th>';
  html += '<th class="p-2 text-left">Name</th>';
  html += '<th class="p-2 text-left">Badge</th>';
  html += '</tr></thead><tbody>';

  for(const p of projects){
    for(const a of p.assigned){
      html += '<tr class="border-b align-top">';
      html += `<td class="p-2">${escapeHtml(p.costCenter)}</td>`;
      html += `<td class="p-2 font-medium">${escapeHtml(p.project)}</td>`;
      html += `<td class="p-2">${escapeHtml(p.craft)}</td>`;
      html += `<td class="p-2">${escapeHtml(p.phase)}</td>`;
      html += `<td class="p-2">${p.start.toISOString().slice(0,10)}</td>`;
      html += `<td class="p-2">${p.end.toISOString().slice(0,10)}</td>`;
      html += `<td class="p-2">${p.qty}</td>`;

      const cls = (a.company === 'TBA') ? 'tba' : '';
      html += `<td class="p-2 ${cls}">${escapeHtml(a.company)}</td>`;
      html += `<td class="p-2 ${cls}">${escapeHtml(a.name)}</td>`;
      html += `<td class="p-2 ${cls}">${escapeHtml(a.badge)}</td>`;

      html += '</tr>';
    }
  }

  html += '</tbody></table></div>';
  document.getElementById('allocationOutput').innerHTML = html;
}

/* ---------- Export to Excel (.xlsx) ---------- */
function exportExcel(projects){
  if(!projects || !projects.length){
    alert('No allocation available to export.');
    return;
  }

  const rows = [];
  rows.push(['Cost Center','Project','Craft','Phase','Start','Finish','Qty','Company','Name','Badge']);

  for(const p of projects){
    for(const a of p.assigned){
      rows.push([
        p.costCenter,
        p.project,
        p.craft,
        p.phase,
        p.start.toISOString().slice(0,10),
        p.end.toISOString().slice(0,10),
        p.qty,
        a.company,
        a.name,
        a.badge
      ]);
    }
  }

  const ws = XLSX.utils.aoa_to_sheet(rows);

  // Optional: set column widths approximate (helps readability)
  const max = col => {
    let width = 10;
    for(let r=0; r<rows.length; r++){
      const v = rows[r][col];
      if(v == null) continue;
      const len = String(v).length;
      if(len > width) width = Math.min(len, 60);
    }
    return { wch: width + 2 };
  };
  ws['!cols'] = [
    max(0), max(1), max(2), max(3), {wch:12}, {wch:12}, {wch:6}, max(7), max(8), max(9)
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Allocation');
  XLSX.writeFile(wb, 'cp_allocation.xlsx');
}

/* ---------- Hook up buttons ---------- */
document.getElementById('btnAllocate').addEventListener('click', allocate);
document.getElementById('btnExport').addEventListener('click', () => exportExcel(lastAllocation));
</script>
</body>
</html>
