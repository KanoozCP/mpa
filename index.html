<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CP Manpower Allocator</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<style>
body {background-color:#f9fafb;}
#allocationOutput { position: relative; }
#allocationOutput::before {
  content:"";
  position:absolute;top:50%;left:50%;
  width:280px;height:280px;
  background:url("https://lh3.googleusercontent.com/d/1oQr4RoR9ON5vK6U_oIN2hW0HdnpEloO8") no-repeat center;
  background-size:contain;
  opacity:0.06;transform:translate(-50%,-50%);
  pointer-events:none;filter:grayscale(80%);
}
.thead-theme{background:linear-gradient(90deg, rgba(10,85,165,0.06), rgba(6,150,105,0.03));}
.tba{color:#b91c1c;font-weight:600;}
.prev-assigned{background-color:#d1fae5;}
.table-wrap{overflow-x:auto;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="flex justify-center items-center h-screen">
  <div class="bg-white p-8 rounded-xl shadow w-80">
    <h2 class="text-2xl font-bold mb-4 text-center">Login</h2>
    <input id="loginUser" type="text" placeholder="Username" class="w-full p-2 mb-3 border rounded">
    <input id="loginPass" type="password" placeholder="Password" class="w-full p-2 mb-4 border rounded">
    <button id="loginBtn" class="w-full bg-blue-700 hover:bg-blue-800 text-white p-2 rounded">Login</button>
    <div id="loginMsg" class="text-red-600 text-sm mt-2 text-center"></div>
  </div>
</div>

<!-- MAIN ALLOCATOR -->
<div id="allocatorScreen" class="max-w-7xl mx-auto p-6 space-y-6 hidden">
  <div class="flex items-center gap-4">
    <img src="https://lh3.googleusercontent.com/d/1oQr4RoR9ON5vK6U_oIN2hW0HdnpEloO8" class="h-16 w-auto">
    <h1 class="text-3xl font-bold text-blue-800">CP Manpower Allocator</h1>
  </div>

  <section class="grid md:grid-cols-2 gap-6">
    <div class="bg-white rounded-xl shadow p-4 space-y-3 border border-blue-200">
      <h2 class="text-lg font-semibold text-blue-700">Upload Manpower List</h2>
      <input type="file" id="manpowerFile" accept=".csv,.xlsx" class="border rounded-lg p-2 w-full"/>
      <div class="text-sm text-gray-500">Required: Company, Name, Badge, Craft, Vacation Start/Finish, Contract Start/End</div>
    </div>

    <div class="bg-white rounded-xl shadow p-4 space-y-3 border border-blue-200">
      <h2 class="text-lg font-semibold text-blue-700">Upload Project List</h2>
      <input type="file" id="projectFile" accept=".csv,.xlsx" class="border rounded-lg p-2 w-full"/>
      <div class="text-sm text-gray-500">Required: Cost Center, Project, Craft, Pre/Main/Post Qty, Start & Finish Dates</div>
    </div>
  </section>

  <div class="flex gap-3">
    <button id="btnAllocate" class="px-4 py-2 rounded-lg bg-blue-700 hover:bg-blue-800 text-white shadow">Allocate</button>
    <button id="btnExport" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white shadow" disabled>Download Excel</button>
    <button id="btnReset" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white shadow">Reset Allocations</button>
  </div>

  <section class="bg-white rounded-xl shadow p-4 relative">
    <h2 class="text-lg font-semibold text-blue-700 mb-3">Allocation</h2>
    <div id="allocationOutput" class="overflow-auto max-h-[36rem] text-sm">
      <div class="text-gray-500">No allocation yet. Upload files and click Allocate.</div>
    </div>
  </section>
</div>

<script>
// ---------- LOGIN ----------
document.getElementById('loginBtn').addEventListener('click',()=>{
  const u=document.getElementById('loginUser').value;
  const p=document.getElementById('loginPass').value;
  if(u==='2025' && p==='2025'){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('allocatorScreen').classList.remove('hidden');
    loadPreviousAllocation();
  }else{
    document.getElementById('loginMsg').textContent='Invalid username or password';
  }
});

// ---------- Helpers ----------
function parseDDMMMYY(s){if(!s)return null;const M={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};const m=String(s).trim().match(/(\d{1,2})[\-\s]([A-Za-z]{3})[\-\s](\d{2,4})/);if(!m)return null;let y=parseInt(m[3],10);if(y<100)y+=2000;return new Date(Date.UTC(y,M[m[2].toLowerCase()],parseInt(m[1],10))); }
function escapeHtml(s){return s?String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])):'';}
function formatDDMMMYY(d){if(!d) return '';const m=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];return ('0'+d.getUTCDate()).slice(-2)+'-'+m[d.getUTCMonth()]+'-'+String(d.getUTCFullYear()).slice(-2); }
function overlaps(a,b,x,y){return a<=y && x<=b;}
function isAvailable(person,start,end){ for(const a of person.assignments) if(overlaps(a.start,a.end,start,end)) return false; if(person.vacStart && person.vacEnd && overlaps(person.vacStart,person.vacEnd,start,end)) return false; if(person.contractStart && start<person.contractStart) return false; if(person.contractEnd && end>person.contractEnd) return false; return true; }

// ---------- File Reading ----------
let manpowerData=[],projectData=[];
function readFile(f,cb){
  const r=new FileReader();
  r.onload=e=>{
    let d=e.target.result,w;
    if(f.name.toLowerCase().endsWith('.csv')) w=XLSX.read(d,{type:'binary',raw:true});
    else w=XLSX.read(new Uint8Array(d),{type:'array'});
    cb(XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]],{defval:''}));
  };
  if(f.name.toLowerCase().endsWith('.csv')) r.readAsBinaryString(f); else r.readAsArrayBuffer(f);
}
document.getElementById('manpowerFile').addEventListener('change',e=>{if(e.target.files[0]) readFile(e.target.files[0],j=>manpowerData=j);});
document.getElementById('projectFile').addEventListener('change',e=>{if(e.target.files[0]) readFile(e.target.files[0],j=>projectData=j);});

// ---------- Memory ----------
let lastAllocation=null;
function loadPreviousAllocation(){
  const saved=JSON.parse(localStorage.getItem('allocation')||'[]');
  if(saved.length>0) document.getElementById('allocationOutput').innerHTML='<div class="text-gray-600">Previous allocation loaded based on badges. Click Allocate to continue.</div>';
}
function saveAllocation(projects){
  const data=[];
  projects.forEach(p=>p.assigned.forEach(a=>data.push({costCenter:p.costCenter,phase:p.phase,craft:p.craft,company:a.company,name:a.name,badge:a.badge})));
  localStorage.setItem('allocation',JSON.stringify(data));
}

// ---------- Allocation ----------
function allocate(){
  if(!manpowerData.length||!projectData.length){alert('Upload both files');return;}
  const people=manpowerData.map(p=>({company:p.Company||'',name:p.Name||'',badge:p.Badge||'',craft:(p.Craft||'').toLowerCase(),vacStart:p['Vacation Start']?parseDDMMMYY(p['Vacation Start']):null,vacEnd:p['Vacation Finish']?parseDDMMMYY(p['Vacation Finish']):null,contractStart:p['Contract Start']?parseDDMMMYY(p['Contract Start']):null,contractEnd:p['Contract End']?parseDDMMMYY(p['Contract End']):null,assignments:[]})).filter(x=>x.name&&x.badge);
  const projects=[];
  projectData.forEach(r=>{['Pre','Main','Post'].forEach(ph=>{const q=parseInt(r[ph+' Qty'])||0,s=parseDDMMMYY(r[ph+' Start']),e=parseDDMMMYY(r[ph+' Finish']);if(q>0&&s&&e)projects.push({costCenter:r['Cost Center']||'',project:r.Project||'',craft:(r.Craft||'').toLowerCase(),qty:q,start:s,end:e,phase:ph,assigned:[]});});});
  const saved=JSON.parse(localStorage.getItem('allocation')||'[]');
  projects.sort((a,b)=>a.start-b.start||a.end-b.end);

  projects.forEach(job=>{
    let rem=job.qty;
    const prevAssigned=saved.filter(s=>s.costCenter===job.costCenter&&s.phase===job.phase&&s.craft===job.craft);
    prevAssigned.forEach(a=>{job.assigned.push({...a,prevAssigned:true}); rem--; if(a.company!=='TBA'){const p=people.find(pp=>pp.badge===a.badge); if(p) p.assignments.push({proj:job.project,start:job.start,end:job.end});}});
    const cands=people.filter(p=>p.craft===job.craft).sort((a,b)=>a.assignments.length-b.assignments.length);
    for(const p of cands){if(rem<=0)break;if(isAvailable(p,job.start,job.end)&&!job.assigned.find(x=>x.badge===p.badge)){p.assignments.push({proj:job.project,start:job.start,end:job.end});job.assigned.push({company:p.company,name:p.name,badge:p.badge,prevAssigned:false});rem--;}}
    for(let i=0;i<rem;i++) job.assigned.push({company:'TBA',name:`(${job.craft})`,badge:'',prevAssigned:false});
  });

  lastAllocation=projects;
  saveAllocation(projects);
  render(projects);
  document.getElementById('btnExport').disabled=false;
}

// ---------- Render ----------
function render(projects){
  if(!projects.length){document.getElementById('allocationOutput').innerHTML='<div class="text-gray-500">No allocation yet.</div>';return;}
  let h='<div class="table-wrap"><table class="min-w-full border text-sm"><thead class="thead-theme"><tr>'+
  '<th class="p-2">Cost Center</th><th class="p-2">Project</th><th class="p-2">Craft</th><th class="p-2">Phase</th>'+
  '<th class="p-2">Start</th><th class="p-2">Finish</th><th class="p-2">Qty</th>'+
  '<th class="p-2">Company</th><th class="p-2">Name</th><th class="p-2">Badge</th></tr></thead><tbody>';
  projects.forEach(p=>p.assigned.forEach(a=>{
    let rowClass=a.company==='TBA'?'tba':(a.prevAssigned?'prev-assigned':'');
    h+=`<tr class="border-b align-top ${rowClass}">`;
    h+=`<td class="p-2">${escapeHtml(p.costCenter)}</td><td class="p-2 font-medium">${escapeHtml(p.project)}</td>`;
    h+=`<td class="p-2">${escapeHtml(p.craft)}</td><td class="p-2">${escapeHtml(p.phase)}</td>`;
    h+=`<td class="p-2">${formatDDMMMYY(p.start)}</td><td class="p-2">${formatDDMMMYY(p.end)}</td>`;
    h+=`<td class="p-2">${p.qty}</td><td class="p-2">${escapeHtml(a.company)}</td><td class="p-2">${escapeHtml(a.name)}</td><td class="p-2">${escapeHtml(a.badge)}</td>`;
    h+='</tr>';
  }));
  h+='</tbody></table></div>';
  document.getElementById('allocationOutput').innerHTML=h;
}

// ---------- Export ----------
function exportExcel(projects){
  if(!projects||!projects.length){alert('No allocation');return;}
  const rows=[['Cost Center','Project','Craft','Phase','Start','Finish','Qty','Company','Name','Badge']];
  projects.forEach(p=>p.assigned.forEach(a=>rows.push([p.costCenter,p.project,p.craft,p.phase,formatDDMMMYY(p.start),formatDDMMMYY(p.end),p.qty,a.company,a.name,a.badge])));
  const ws=XLSX.utils.aoa_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Allocation');
  XLSX.writeFile(wb,'cp_allocation.xlsx');
}

// ---------- Buttons ----------
document.getElementById('btnAllocate').addEventListener('click',allocate);
document.getElementById('btnExport').addEventListener('click',()=>exportExcel(lastAllocation));
document.getElementById('btnReset').addEventListener('click',()=>{
  if(confirm('This will clear all previous allocations. Continue?')){
    localStorage.removeItem('allocation'); lastAllocation=null;
    document.getElementById('allocationOutput').innerHTML='<div class="text-gray-500">Allocations reset. You can start fresh.</div>';
    document.getElementById('btnExport').disabled=true;
  }
});
</script>
</body>
</html>
