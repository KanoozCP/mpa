<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Phase-wise Manpower Allocator</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
<div class="max-w-7xl mx-auto p-6 space-y-6">
  <h1 class="text-2xl font-bold">Phase-wise Manpower Allocator</h1>

  <!-- File Uploads -->
  <section class="grid md:grid-cols-2 gap-6">
    <div class="bg-white rounded-xl shadow p-4 space-y-3">
      <h2 class="text-lg font-semibold">Upload Manpower List</h2>
      <input type="file" id="manpowerFile" accept=".csv, .xlsx" class="border rounded-lg p-2 w-full"/>
      <p class="text-sm text-gray-500">
        Columns: Company, Name, Badge, Craft, Vacation Start, Vacation Finish, Contract Start, Contract End
      </p>
    </div>
    <div class="bg-white rounded-xl shadow p-4 space-y-3">
      <h2 class="text-lg font-semibold">Upload Project List</h2>
      <input type="file" id="projectFile" accept=".csv, .xlsx" class="border rounded-lg p-2 w-full"/>
      <p class="text-sm text-gray-500">
        Columns: Cost Center, Project, Craft, Pre Qty, Pre Start, Pre Finish, Main Qty, Main Start, Main Finish, Post Qty, Post Start, Post Finish
      </p>
    </div>
  </section>

  <!-- Buttons -->
  <div class="flex gap-3">
    <button id="btnAllocate" class="px-4 py-2 rounded-lg bg-blue-600 text-white shadow">Allocate</button>
    <button id="btnExport" class="px-4 py-2 rounded-lg bg-emerald-600 text-white shadow" disabled>Download CSV</button>
  </div>

  <!-- Output -->
  <section class="bg-white rounded-xl shadow p-4">
    <h2 class="text-lg font-semibold mb-3">Allocation</h2>
    <div id="allocationOutput" class="overflow-auto max-h-[32rem] text-sm"></div>
  </section>
</div>

<script>
let manpowerData = [];
let projectData = [];

function parseDDMMMYY(s){
  if(!s) return null;
  const MONTHS={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
  const m = String(s).trim().match(/(\d{1,2})[\-\s]([A-Za-z]{3})[\-\s](\d{2,4})/);
  if(!m) return null;
  let y = parseInt(m[3],10);
  if(y<100) y+=2000;
  return new Date(Date.UTC(y, MONTHS[m[2].toLowerCase()], parseInt(m[1],10)));
}

function readFile(file, callback){
  const reader = new FileReader();
  reader.onload = e => {
    let data = e.target.result;
    let workbook;
    if(file.name.endsWith('.csv')){
      workbook = XLSX.read(data, {type:'binary', raw:true, codepage:65001});
    } else {
      const arr = new Uint8Array(data);
      workbook = XLSX.read(arr, {type:'array'});
    }
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(sheet, {defval:''});
    callback(json);
  };
  if(file.name.endsWith('.csv')){
    reader.readAsBinaryString(file);
  } else {
    reader.readAsArrayBuffer(file);
  }
}

document.getElementById('manpowerFile').addEventListener('change', e => {
  if(e.target.files.length){
    readFile(e.target.files[0], data => {manpowerData=data;});
  }
});

document.getElementById('projectFile').addEventListener('change', e => {
  if(e.target.files.length){
    readFile(e.target.files[0], data => {projectData=data;});
  }
});

function overlaps(a,b,x,y){ return a<=y && x<=b; }

function isAvailable(person,start,end){
  for(const a of person.assignments){
    if(overlaps(a.start,a.end,start,end)) return false;
  }
  if(person.vacStart && person.vacEnd && overlaps(person.vacStart,person.vacEnd,start,end)) return false;
  if(person.contractStart && start<person.contractStart) return false;
  if(person.contractEnd && end>person.contractEnd) return false;
  return true;
}

function allocate(){
  if(!manpowerData.length || !projectData.length){alert('Upload both files first'); return;}

  const people = manpowerData.map(p=>({
    company:p.Company||'',
    name:p.Name||'',
    badge:p.Badge||'',
    craft:(p.Craft||'').toLowerCase(),
    vacStart: parseDDMMMYY(p['Vacation Start']),
    vacEnd: parseDDMMMYY(p['Vacation Finish']),
    contractStart: parseDDMMMYY(p['Contract Start']),
    contractEnd: parseDDMMMYY(p['Contract End']),
    assignments:[]
  })).filter(p=>p.name && p.badge);

  const projects = [];
  projectData.forEach(p=>{
    ['Pre','Main','Post'].forEach(phase=>{
      const qty = parseInt(p[phase+' Qty'])||0;
      const start = parseDDMMMYY(p[phase+' Start']);
      const end = parseDDMMMYY(p[phase+' Finish']);
      if(qty>0 && start && end){
        projects.push({
          costCenter: p['Cost Center']||'',
          project: p.Project||'',
          craft: (p.Craft||'').toLowerCase(),
          qty: qty,
          start: start,
          end: end,
          phase: phase,
          assigned:[]
        });
      }
    });
  });

  projects.sort((a,b)=>a.start-b.start);

  projects.forEach(job=>{
    let remaining = job.qty;
    for(const p of people.filter(x=>x.craft===job.craft)){
      if(remaining<=0) break;
      if(isAvailable(p, job.start, job.end)){
        p.assignments.push({proj:job.project, start:job.start, end:job.end});
        job.assigned.push(`${p.company} • ${p.name} • ${p.badge}`);
        remaining--;
      }
    }
    for(let i=0;i<remaining;i++) job.assigned.push(`TBA (${job.craft})`);
  });

  render(projects);
  document.getElementById('btnExport').disabled=false;
  document.getElementById('btnExport').onclick=()=>exportCSV(projects);
}

function render(projects){
  let html=`<table class='min-w-full border text-sm'><tr class='bg-gray-100'><th class=p-2>Cost Center</th><th class=p-2>Project</th><th class=p-2>Craft</th><th class=p-2>Phase</th><th class=p-2>Start</th><th class=p-2>Finish</th><th class=p-2>Qty</th><th class=p-2>Assigned</th></tr>`;
  projects.forEach(p=>{
    html+=`<tr class='border-b'><td class=p-2>${p.costCenter}</td><td class=p-2>${p.project}</td><td class=p-2>${p.craft}</td><td class=p-2>${p.phase}</td><td class=p-2>${p.start.toISOString().slice(0,10)}</td><td class=p-2>${p.end.toISOString().slice(0,10)}</td><td class=p-2>${p.qty}</td><td class=p-2>${p.assigned.join('<br>')}</td></tr>`;
  });
  html+=`</table>`;
  document.getElementById('allocationOutput').innerHTML=html;
}

function exportCSV(projects){
  const lines=['Cost Center,Project,Craft,Phase,Start,Finish,Qty,Assigned'];
  projects.forEach(p=>{
    lines.push([p.costCenter,p.project,p.craft,p.phase,p.start.toISOString().slice(0,10),p.end.toISOString().slice(0,10),p.qty,`\"${p.assigned.join(' | ')}\"`].join(','));
  });
  const blob=new Blob([lines.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='allocation.csv';
  a.click();
}

document.getElementById('btnAllocate').onclick=allocate;
</script>
</body>
</html>
